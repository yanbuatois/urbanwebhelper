{"version":3,"sources":["../app.js"],"names":["createError","require","express","path","cookieParser","logger","session","compression","UROAuth","config","indexRouter","usersRouter","loginRouter","collectionRouter","missionsRouter","app","set","join","__dirname","use","process","env","NODE_ENV","json","urlencoded","extended","secret","resave","saveUninitialized","cookie","expires","Date","now","static","req","res","next","access_token","default","urApi","key","token","query","then","result","player","context","catch","undefined","finally","originalPath","originalUrl","redirect","get","destroy","err","render","error","locals","message","status","module","exports"],"mappings":"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","sourcesContent":["const createError = require('http-errors');\nconst express = require('express');\nconst path = require('path');\nconst cookieParser = require('cookie-parser');\nconst logger = require('morgan');\nconst session = require('express-session');\nconst compression = require('compression');\n\nconst UROAuth = require('./classes/oauthurban');\nconst config = require('./config');\n\nconst indexRouter = require('./routes/index');\nconst usersRouter = require('./routes/users');\nconst loginRouter = require('./routes/login');\nconst collectionRouter = require('./routes/collection');\nconst missionsRouter = require('./routes/missions');\n\nconst app = express();\n\n// view engine setup\napp.set('views', path.join(__dirname, 'views'));\napp.set('view engine', 'twig');\n\napp.use(logger('dev'));\nif(process.env.NODE_ENV === 'production') {\n  app.use(compression());\n}\napp.use(express.json());\napp.use(express.urlencoded({ extended: false }));\napp.use(cookieParser());\napp.use(session({\n  secret: \"J'apprÃ©cie les fruits au sirop !\",\n  resave: true,\n  saveUninitialized: true,\n  cookie: {\n    expires: Date.now() + 60*60*24*7,\n  }\n}));\napp.use(express.static(path.join(__dirname, 'public')));\n\napp.use((req, res, next) => {\n  if(req.session.access_token && req.path !== '/logout') {\n    req.default = {};\n    /**\n     * Ur API\n     * @type {module.UrbanOAuth}\n     */\n    req.urApi = new UROAuth(config.key, config.secret);\n    req.urApi.token = req.session.access_token;\n    req.urApi.query(\"general.getPlayer\")\n      .then((result) => {\n        req.default.player = result.context.player;\n      })\n      .catch(() => {\n        req.session.access_token = undefined;\n      })\n      .finally(() => {\n        next();\n      })\n  }\n  else\n    next();\n})\n  .use((req, res, next) => {\n  if(req.path !== '/login' && req.path !== '/authorized' && !req.session.access_token && req.path !== '/logout' && req.path !== '/cleartoken') {\n    req.session.originalPath = req.originalUrl;\n    res.redirect('/login');\n  }\n  else {\n    next();\n  }\n})\n\n  .get('/logout',(req, res, next) => {\n    req.session.destroy((err) => {\n      if(err)\n        res.render('errors/apierror', {error: err});\n      else\n        res.render('logout');\n    })\n  });\n\napp.use(loginRouter);\napp.use('/', indexRouter);\napp.use('/user', usersRouter);\napp.use(missionsRouter);\napp.use('/collection',collectionRouter);\n\n// catch 404 and forward to error handler\napp.use(function(req, res, next) {\n    next(createError(404));\n});\n\n// error handler\napp.use(function(err, req, res, next) {\n  // set locals, only providing error in development\n  res.locals.message = err.message;\n  res.locals.error = req.app.get('env') === 'development' ? err : {};\n\n  // render the error page\n  res.status(err.status || 500);\n\nres.render('errors/error');\n});\n\nmodule.exports = app;\n"],"file":"app.js"}